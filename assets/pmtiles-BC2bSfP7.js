var A=Math.pow,m=(e,t,r)=>new Promise((n,i)=>{var o=f=>{try{l(r.next(f))}catch(u){i(u)}},s=f=>{try{l(r.throw(f))}catch(u){i(u)}},l=f=>f.done?n(f.value):Promise.resolve(f.value).then(o,s);l((r=r.apply(e,t)).next())}),w=Uint8Array,Z=Uint16Array,He=Int32Array,de=new w([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ge=new w([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Oe=new w([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ve=function(e,t){for(var r=new Z(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var i=new He(r[30]),n=1;n<30;++n)for(var o=r[n];o<r[n+1];++o)i[o]=o-r[n]<<5|n;return{b:r,r:i}},me=ve(de,2),ye=me.b,Be=me.r;ye[28]=258,Be[258]=28;var Ze=ve(ge,0),$e=Ze.b,pe=new Z(32768);for(h=0;h<32768;++h)E=(h&43690)>>1|(h&21845)<<1,E=(E&52428)>>2|(E&13107)<<2,E=(E&61680)>>4|(E&3855)<<4,pe[h]=((E&65280)>>8|(E&255)<<8)>>1;var E,h,$=function(e,t,r){for(var n=e.length,i=0,o=new Z(t);i<n;++i)e[i]&&++o[e[i]-1];var s=new Z(t);for(i=1;i<t;++i)s[i]=s[i-1]+o[i-1]<<1;var l;{l=new Z(1<<t);var f=15-t;for(i=0;i<n;++i)if(e[i])for(var u=i<<4|e[i],a=t-e[i],c=s[e[i]-1]++<<a,d=c|(1<<a)-1;c<=d;++c)l[pe[c]>>f]=u}return l},S=new w(288);for(h=0;h<144;++h)S[h]=8;var h;for(h=144;h<256;++h)S[h]=9;var h;for(h=256;h<280;++h)S[h]=7;var h;for(h=280;h<288;++h)S[h]=8;var h,we=new w(32);for(h=0;h<32;++h)we[h]=5;var h,Se=$(S,9),Pe=$(we,5),J=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},L=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},Y=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},Ie=function(e){return(e+7)/8|0},ke=function(e,t,r){(r==null||r>e.length)&&(r=e.length);var n=new w(r-t);return n.set(e.subarray(t,r)),n},Re=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],p=function(e,t,r){var n=new Error(t||Re[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,p),!r)throw n;return n},Q=function(e,t,r,n){var i=e.length,o=0;if(!i||t.f&&!t.l)return r||new w(0);var s=!r||t.i!=2,l=t.i;r||(r=new w(i*3));var f=function(ae){var ce=r.length;if(ae>ce){var le=new w(Math.max(ce*2,ae));le.set(r),r=le}},u=t.f||0,a=t.p||0,c=t.b||0,d=t.l,y=t.d,g=t.m,x=t.n,T=i*8;do{if(!d){u=L(e,a,1);var P=L(e,a+1,3);if(a+=3,P)if(P==1)d=Se,y=Pe,g=9,x=5;else if(P==2){var _=L(e,a,31)+257,ee=L(e,a+10,15)+4,te=_+L(e,a+5,31)+1;a+=14;for(var V=new w(te),W=new w(19),D=0;D<ee;++D)W[Oe[D]]=L(e,a+D*3,7);a+=ee*3;for(var re=J(W),Ce=(1<<re)-1,ze=$(W,re),D=0;D<te;){var ne=ze[L(e,a,Ce)];a+=ne&15;var v=ne>>4;if(v<16)V[D++]=v;else{var C=0,I=0;for(v==16?(I=3+L(e,a,3),a+=2,C=V[D-1]):v==17?(I=3+L(e,a,7),a+=3):v==18&&(I=11+L(e,a,127),a+=7);I--;)V[D++]=C}}var ie=V.subarray(0,_),U=V.subarray(_);g=J(ie),x=J(U),d=$(ie,g),y=$(U,x)}else p(1);else{var v=Ie(a)+4,R=e[v-4]|e[v-3]<<8,K=v+R;if(K>i){l&&p(0);break}s&&f(c+R),r.set(e.subarray(v,K),c),t.b=c+=R,t.p=a=K*8,t.f=u;continue}if(a>T){l&&p(0);break}}s&&f(c+131072);for(var Me=(1<<g)-1,Ae=(1<<x)-1,j=a;;j=a){var C=d[Y(e,a)&Me],z=C>>4;if(a+=C&15,a>T){l&&p(0);break}if(C||p(2),z<256)r[c++]=z;else if(z==256){j=a,d=null;break}else{var oe=z-254;if(z>264){var D=z-257,H=de[D];oe=L(e,a,(1<<H)-1)+ye[D],a+=H}var N=y[Y(e,a)&Ae],q=N>>4;N||p(3),a+=N&15;var U=$e[q];if(q>3){var H=ge[q];U+=Y(e,a)&(1<<H)-1,a+=H}if(a>T){l&&p(0);break}s&&f(c+131072);var F=c+oe;if(c<U){var se=o-U,Ve=Math.min(U,F);for(se+c<0&&p(3);c<Ve;++c)r[c]=n[se+c]}for(;c<F;c+=4)r[c]=r[c-U],r[c+1]=r[c+1-U],r[c+2]=r[c+2-U],r[c+3]=r[c+3-U];c=F}}t.l=d,t.p=j,t.b=c,t.f=u,d&&(u=1,t.m=g,t.d=y,t.n=x)}while(!u);return c==r.length?r:ke(r,0,c)},Ke=new w(0),_e=function(e){(e[0]!=31||e[1]!=139||e[2]!=8)&&p(6,"invalid gzip data");var t=e[3],r=10;t&4&&(r+=(e[10]|e[11]<<8)+2);for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[r++]);return r+(t&2)},We=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},je=function(e,t){return((e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&p(6,"invalid zlib data"),(e[1]>>5&1)==1&&p(6,"invalid zlib data: "+(e[1]&32?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function Ne(e,t){return Q(e,{i:2},t,t)}function qe(e,t){var r=_e(e);return r+8>e.length&&p(6,"invalid gzip data"),Q(e.subarray(r,-8),{i:2},new w(We(e)),t)}function Fe(e,t){return Q(e.subarray(je(e),-4),{i:2},t,t)}function X(e,t){return e[0]==31&&e[1]==139&&e[2]==8?qe(e,t):(e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?Ne(e,t):Fe(e,t)}var Je=typeof TextDecoder<"u"&&new TextDecoder,Ye=0;try{Je.decode(Ke,{stream:!0}),Ye=1}catch{}var De=(e,t)=>e*A(2,t),O=(e,t)=>Math.floor(e/A(2,t)),k=(e,t)=>De(e.getUint16(t+1,!0),8)+e.getUint8(t),xe=(e,t)=>De(e.getUint32(t+2,!0),16)+e.getUint16(t,!0),Xe=(e,t,r,n,i)=>{if(e!==n.getUint8(i))return e-n.getUint8(i);const o=k(n,i+1);if(t!==o)return t-o;const s=k(n,i+4);return r!==s?r-s:0},Ge=(e,t,r,n)=>{const i=Ue(e,t|128,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],isDir:!0}:null},fe=(e,t,r,n)=>{const i=Ue(e,t,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],isDir:!1}:null},Ue=(e,t,r,n)=>{let i=0,o=e.byteLength/17-1;for(;i<=o;){const s=o+i>>1,l=Xe(t,r,n,e,s*17);if(l>0)i=s+1;else if(l<0)o=s-1;else return[xe(e,s*17+7),e.getUint32(s*17+13,!0)]}return null},Qe=(e,t)=>e.isDir&&!t.isDir?1:!e.isDir&&t.isDir?-1:e.z!==t.z?e.z-t.z:e.x!==t.x?e.x-t.x:e.y-t.y,Le=(e,t)=>{const r=e.getUint8(t*17);return{z:r&127,x:k(e,t*17+1),y:k(e,t*17+4),offset:xe(e,t*17+7),length:e.getUint32(t*17+13,!0),isDir:r>>7===1}},ue=e=>{const t=[],r=new DataView(e);for(let n=0;n<r.byteLength/17;n++)t.push(Le(r,n));return et(t)},et=e=>{e.sort(Qe);const t=new ArrayBuffer(17*e.length),r=new Uint8Array(t);for(let n=0;n<e.length;n++){const i=e[n];let o=i.z;i.isDir&&(o=o|128),r[n*17]=o,r[n*17+1]=i.x&255,r[n*17+2]=i.x>>8&255,r[n*17+3]=i.x>>16&255,r[n*17+4]=i.y&255,r[n*17+5]=i.y>>8&255,r[n*17+6]=i.y>>16&255,r[n*17+7]=i.offset&255,r[n*17+8]=O(i.offset,8)&255,r[n*17+9]=O(i.offset,16)&255,r[n*17+10]=O(i.offset,24)&255,r[n*17+11]=O(i.offset,32)&255,r[n*17+12]=O(i.offset,48)&255,r[n*17+13]=i.length&255,r[n*17+14]=i.length>>8&255,r[n*17+15]=i.length>>16&255,r[n*17+16]=i.length>>24&255}return t},tt=(e,t)=>{if(e.byteLength<17)return null;const r=e.byteLength/17,n=Le(e,r-1);if(n.isDir){const i=n.z,o=t.z-i,s=Math.trunc(t.x/(1<<o)),l=Math.trunc(t.y/(1<<o));return{z:i,x:s,y:l}}return null};function rt(e){return m(this,null,function*(){const t=yield e.getBytes(0,512e3),r=new DataView(t.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),o=new TextDecoder("utf-8"),s=JSON.parse(o.decode(new DataView(t.data,10,n)));let l=0;s.compression==="gzip"&&(l=2);let f=0;"minzoom"in s&&(f=+s.minzoom);let u=0;"maxzoom"in s&&(u=+s.maxzoom);let a=0,c=0,d=0,y=-180,g=-85,x=180,T=85;if(s.bounds){const v=s.bounds.split(",");y=+v[0],g=+v[1],x=+v[2],T=+v[3]}if(s.center){const v=s.center.split(",");a=+v[0],c=+v[1],d=+v[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:l,tileType:1,minZoom:f,maxZoom:u,minLon:y,minLat:g,maxLon:x,maxLat:T,centerZoom:d,centerLon:a,centerLat:c,etag:t.etag}})}function nt(e,t,r,n,i,o,s){return m(this,null,function*(){let l=yield r.getArrayBuffer(t,e.rootDirectoryOffset,e.rootDirectoryLength,e);e.specVersion===1&&(l=ue(l));const f=fe(new DataView(l),n,i,o);if(f){let c=(yield t.getBytes(f.offset,f.length,s)).data;const d=new DataView(c);return d.getUint8(0)===31&&d.getUint8(1)===139&&(c=X(new Uint8Array(c))),{data:c}}const u=tt(new DataView(l),{z:n,x:i,y:o});if(u){const a=Ge(new DataView(l),u.z,u.x,u.y);if(a){let c=yield r.getArrayBuffer(t,a.offset,a.length,e);e.specVersion===1&&(c=ue(c));const d=fe(new DataView(c),n,i,o);if(d){let g=(yield t.getBytes(d.offset,d.length,s)).data;const x=new DataView(g);return x.getUint8(0)===31&&x.getUint8(1)===139&&(g=X(new Uint8Array(g))),{data:g}}}}})}var be={getHeader:rt,getZxy:nt},it=e=>(t,r)=>{if(r instanceof AbortController)return e(t,r);const n=new AbortController;return e(t,n).then(i=>r(void 0,i.data,i.cacheControl||"",i.expires||""),i=>r(i)).catch(i=>r(i)),{cancel:()=>n.abort()}},pt=class{constructor(e){this.tilev4=(t,r)=>m(this,null,function*(){if(t.type==="json"){const d=t.url.substr(10);let y=this.tiles.get(d);if(y||(y=new he(d),this.tiles.set(d,y)),this.metadata)return{data:yield y.getTileJson(t.url)};const g=yield y.getHeader();return{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:g.minZoom,maxzoom:g.maxZoom,bounds:[g.minLon,g.minLat,g.maxLon,g.maxLat]}}}const n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=t.url.match(n);if(!i)throw new Error("Invalid PMTiles protocol URL");const o=i[1];let s=this.tiles.get(o);s||(s=new he(o),this.tiles.set(o,s));const l=i[2],f=i[3],u=i[4],a=yield s.getHeader(),c=yield s==null?void 0:s.getZxy(+l,+f,+u,r.signal);return c?{data:new Uint8Array(c.data),cacheControl:c.cacheControl,expires:c.expires}:a.tileType===1?{data:new Uint8Array}:{data:null}}),this.tile=it(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};function M(e,t){return(t>>>0)*4294967296+(e>>>0)}function ot(e,t){const r=t.buf;let n=r[t.pos++],i=(n&112)>>4;if(n<128||(n=r[t.pos++],i|=(n&127)<<3,n<128)||(n=r[t.pos++],i|=(n&127)<<10,n<128)||(n=r[t.pos++],i|=(n&127)<<17,n<128)||(n=r[t.pos++],i|=(n&127)<<24,n<128)||(n=r[t.pos++],i|=(n&1)<<31,n<128))return M(e,i);throw new Error("Expected varint not more than 10 bytes")}function B(e){const t=e.buf;let r=t[e.pos++],n=r&127;return r<128||(r=t[e.pos++],n|=(r&127)<<7,r<128)||(r=t[e.pos++],n|=(r&127)<<14,r<128)||(r=t[e.pos++],n|=(r&127)<<21,r<128)?n:(r=t[e.pos],n|=(r&15)<<28,ot(n,e))}function st(e,t,r,n){if(n===0){r===1&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);const i=t[0];t[0]=t[1],t[1]=i}}var at=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function ct(e,t,r){if(e>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(t>A(2,e)-1||r>A(2,e)-1)throw Error("tile x/y outside zoom level bounds");const n=at[e],i=A(2,e);let o=0,s=0,l=0;const f=[t,r];let u=i/2;for(;u>0;)o=(f[0]&u)>0?1:0,s=(f[1]&u)>0?1:0,l+=u*u*(3*o^s),st(u,f,o,s),u=u/2;return n+l}function Ee(e,t){return m(this,null,function*(){if(t===1||t===0)return e;if(t===2){if(typeof globalThis.DecompressionStream>"u")return X(new Uint8Array(e));const r=new Response(e).body;if(!r)throw Error("Failed to read response stream");const n=r.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw Error("Compression method not supported")})}function lt(e){return e===1?".mvt":e===2?".png":e===3?".jpg":e===4?".webp":e===5?".avif":""}var ft=127;function ut(e,t){let r=0,n=e.length-1;for(;r<=n;){const i=n+r>>1,o=t-e[i].tileId;if(o>0)r=i+1;else if(o<0)n=i-1;else return e[i]}return n>=0&&(e[n].runLength===0||t-e[n].tileId<e[n].runLength)?e[n]:null}var ht=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");const n=r.indexOf("Windows")>-1,i=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,n&&i&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,n){return m(this,null,function*(){let i,o;r?o=r:(i=new AbortController,o=i.signal);const s=new Headers(this.customHeaders);s.set("range",`bytes=${e}-${e+t-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let f=yield fetch(this.url,{signal:o,cache:l,headers:s});if(e===0&&f.status===416){const d=f.headers.get("Content-Range");if(!d||!d.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const y=+d.substr(8);f=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${y-1}`}})}let u=f.headers.get("Etag");if(u!=null&&u.startsWith("W/")&&(u=null),f.status===416||n&&u&&u!==n)throw this.mustReload=!0,new G(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(f.status>=300)throw Error(`Bad response code: ${f.status}`);const a=f.headers.get("Content-Length");if(f.status===200&&(!a||+a>t))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield f.arrayBuffer(),etag:u||void 0,cacheControl:f.headers.get("Cache-Control")||void 0,expires:f.headers.get("Expires")||void 0}})}};function b(e,t){const r=e.getUint32(t+4,!0),n=e.getUint32(t+0,!0);return r*A(2,32)+n}function dt(e,t){const r=new DataView(e),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:b(r,8),rootDirectoryLength:b(r,16),jsonMetadataOffset:b(r,24),jsonMetadataLength:b(r,32),leafDirectoryOffset:b(r,40),leafDirectoryLength:b(r,48),tileDataOffset:b(r,56),tileDataLength:b(r,64),numAddressedTiles:b(r,72),numTileEntries:b(r,80),numTileContents:b(r,88),clustered:r.getUint8(96)===1,internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}function Te(e){const t={buf:new Uint8Array(e),pos:0},r=B(t),n=[];let i=0;for(let o=0;o<r;o++){const s=B(t);n.push({tileId:i+s,offset:0,length:0,runLength:1}),i+=s}for(let o=0;o<r;o++)n[o].runLength=B(t);for(let o=0;o<r;o++)n[o].length=B(t);for(let o=0;o<r;o++){const s=B(t);s===0&&o>0?n[o].offset=n[o-1].offset+n[o-1].length:n[o].offset=s-1}return n}function gt(e){const t=new DataView(e);return t.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):t.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var G=class extends Error{};function vt(e,t){return m(this,null,function*(){const r=yield e.getBytes(0,16384);if(new DataView(r.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(gt(r.data)<3)return[yield be.getHeader(e)];const i=r.data.slice(0,ft),o=dt(i,r.etag),s=r.data.slice(o.rootDirectoryOffset,o.rootDirectoryOffset+o.rootDirectoryLength),l=`${e.getKey()}|${o.etag||""}|${o.rootDirectoryOffset}|${o.rootDirectoryLength}`,f=Te(yield t(s,o.internalCompression));return[o,[l,f.length,f]]})}function mt(e,t,r,n,i){return m(this,null,function*(){const o=yield e.getBytes(r,n,void 0,i.etag),s=yield t(o.data,i.internalCompression),l=Te(s);if(l.length===0)throw new Error("Empty directory is invalid");return l})}var yt=class{constructor(e=100,t=!0,r=Ee){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return m(this,null,function*(){const t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;const n=new Promise((i,o)=>{vt(e,this.decompress).then(s=>{s[1]&&this.cache.set(s[1][0],{lastUsed:this.counter++,data:Promise.resolve(s[1][2])}),i(s[0]),this.prune()}).catch(s=>{o(s)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,r,n){return m(this,null,function*(){const i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,yield o.data;const s=new Promise((l,f)=>{mt(e,this.decompress,t,r,n).then(u=>{l(u),this.prune()}).catch(u=>{f(u)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}getArrayBuffer(e,t,r,n){return m(this,null,function*(){const i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,yield o.data;const s=new Promise((l,f)=>{e.getBytes(t,r,void 0,n.etag).then(u=>{l(u.data),this.cache.has(i),this.prune()}).catch(u=>{f(u)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return m(this,null,function*(){const t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());const r=new Promise((n,i)=>{this.getHeader(e).then(o=>{n(),this.invalidations.delete(t)}).catch(o=>{i(o)})});this.invalidations.set(t,r)})}},he=class{constructor(e,t,r){typeof e=="string"?this.source=new ht(e):this.source=e,r?this.decompress=r:this.decompress=Ee,t?this.cache=t:this.cache=new yt}getHeader(){return m(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,n){return m(this,null,function*(){const i=ct(e,t,r),o=yield this.cache.getHeader(this.source);if(o.specVersion<3)return be.getZxy(o,this.source,this.cache,e,t,r,n);if(e<o.minZoom||e>o.maxZoom)return;let s=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let f=0;f<=3;f++){const u=yield this.cache.getDirectory(this.source,s,l,o),a=ut(u,i);if(a){if(a.runLength>0){const c=yield this.source.getBytes(o.tileDataOffset+a.offset,a.length,n,o.etag);return{data:yield this.decompress(c.data,o.tileCompression),cacheControl:c.cacheControl,expires:c.expires}}s=o.leafDirectoryOffset+a.offset,l=a.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(e,t,r,n){return m(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,n)}catch(i){if(i instanceof G)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,n);throw i}})}getMetadataAttempt(){return m(this,null,function*(){const e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return m(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof G)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return m(this,null,function*(){const t=yield this.getHeader(),r=yield this.getMetadata(),n=lt(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};export{pt as P};
//# sourceMappingURL=pmtiles-BC2bSfP7.js.map
